# 浏览器缓存策略

## 大纲

1. [强缓存](#强缓存)
   1. Expire
   2. Cache-Control的值为“public, max-age=xxx”
2. [协商缓存](#协商缓存)
   1. Etag/If-None-Match
   2. Last-Modifed/If-Modified-Since

## 强缓存

浏览器不会像服务器发送任何请求，直接从本地缓存中读取文件并返回

## 协商缓存

向服务器发送请求，服务器会根据这个请求的request header的一些参数来判断是否命中协商缓存，如果命中，则返回304状态码并带上新的response header通知浏览器从缓存中读取资源

- Last-Modifed/If-Modified-Since的时间精度是秒，而Etag可以更精确。
- Etag优先级是高于Last-Modifed的，所以服务器会优先验证Etag
- Last-Modifed/If-Modified-Since是http1.0的头字段

### Etag

Etag是属于HTTP 1.1属性，它是由服务器（Apache或者其他工具）生成返回给前端，用来帮助服务器控制Web端的缓存验证。
Apache中，ETag的值，默认是对文件的索引节（INode），大小（Size）和最后修改时间（MTime）进行Hash后得到的。

Etag/If-None-Match 优先级高于 Last-Modifed/If-Modified-Since

### If-None-Match

再次请求服务器时，浏览器的请求报文头部会包含此字段，后面的值为在缓存中获取的标识。服务器接收到次报文后发现If-None-Match则与被请求资源的唯一标识进行对比

- 不同，说明资源被改动过，则响应整个资源内容，返回状态码200。
- 相同，说明资源无心修改，则响应header，浏览器直接从缓存中获取数据信息。返回状态码304.

### Last-Modified

服务器在响应请求时，会告诉浏览器资源的最后修改时间。

### If-Modified-Since

浏览器再次请求服务器的时候，请求头会包含此字段，后面跟着在缓存中获得的最后修改时间。服务端收到此请求头发现有if-Modified-Since，则与被请求资源的最后修改时间进行对比，如果一致则返回304和响应报文头，浏览器只需要从缓存中获取信息即可。

- 被修改：那么开始传输响应一个整体，服务器返回：200 OK
- 没有被修改：那么只需传输响应header，服务器返回：304 Not Modified
